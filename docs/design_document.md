# PyxelPatch 設計書

## 1. 概要
**PyxelPatch** は、Python言語とレトロゲームフレームワーク [Pyxel](https://github.com/kitao/pyxel) を用いて構築する、**ノードベースの音楽＆ビジュアルソフトウェア** です。Cycling '74 の **Max** (Max/MSP) に着想を得ており、複数の **ノード**（アプリケーションのコンポーネント）を組み合わせることで音楽や映像生成を行います。各ノードは独立したウィンドウで動作し、ノード間の通信は **MIDI** メッセージをUDPソケットで送受信することで実現します。

大まかな構成は以下のとおりです。

- **リズムジェネレータ (RhythmGeneratorNode)**  
  システムのマスタークロックとして動作し、同期信号（テンポ, 拍, ステップなど）を出力。システム内で唯一のインスタンスとして存在し、他のノードはこれに同期する。
- **リズムマシン (RhythmNode)**  
  リズムジェネレータからの同期信号に基づいてドラムパターンを生成。
- **シンセ (SynthNode)**  
  MIDIノート入力から音声を生成するシンセサイザ。単純な波形合成を Pyxel のサウンド機能で行う。
- **映像ジェネレータ (VideoNode)**  
  MIDIメッセージやリズムにあわせて映像を生成・表示。Pyxelのグラフィック機能を使い、パーティクルなどの簡易ビジュアルを出力。
- **ゲーム (GameNode)**  
  Pyxelを使った簡単なゲーム機能。ユーザ操作やリズムに応じて音楽イベントを発火したり、逆にMIDIノートを受け取ったりする。

これらのノードはそれぞれ独立したウィンドウとして動作し、UDPソケットを介したMIDIメッセージのやり取りで連携します。各ノードは独立したディレクトリ（モジュール）として管理され、共通のインターフェース（基底クラス）を実装することで、**ソフトウェアデザインの一貫性** を保ちます。

## 2. アーキテクチャ

### 2.1 ノードベース構造
各ノードは独立したウィンドウとして動作し、それぞれが独自のPyxelアプリケーションとして実装されます。リズムジェネレータ、リズムマシン、シンセ、映像、ゲームなどをそれぞれ個別のフォルダ・スクリプトに分け実装します。

1. **RhythmGeneratorNode**  
   - システム唯一のマスタークロックとして動作  
   - テンポ（BPM）の管理と同期信号の生成  
   - MIDIクロックメッセージを他ノードに送信  
   - テンポを可変にし、UIやMIDIでBPMを変更可能  

2. **RhythmNode**  
   - リズムジェネレータからの同期信号に基づいてドラムパターンを生成  
   - パターンの編集・保存機能  
   - MIDIノート出力でドラム音を制御  

3. **SynthNode**  
   - MIDIノート入力を受けて音を再生する  
   - PyxelのサウンドAPIを用いて合成音を生成  
   - ボリュームや波形などをMIDI CCでコントロール可能  

4. **VideoNode**  
   - MIDIイベントに反応してビジュアル（パーティクルやフラッシュなど）を描画  
   - リズムからの同期信号により、拍やステップで映像を変化させる  
   - Pyxelの描画機能（`pyxel.rect()`, `pyxel.circ()`等）を利用  

5. **GameNode**  
   - Pyxel上で動作する簡易ゲーム。ユーザのキーボード入力やPyxelの操作を受け付ける  
   - イベント発生時にMIDIノートを生成し、シンセを鳴らしたり、映像を動かしたりできる  
   - ゲームロジック内でリズムやシンセからのイベントを受け、ゲーム難易度や動作を変化させるなども可能  

### 2.2 ノード間通信と同期システム

#### 2.2.1 MIDI over UDP
各ノードはUDPソケットを使用してMIDIメッセージを送受信します：
- **メッセージ形式**: JSON形式でシリアライズ
- **通信方式**: ブロードキャスト（全ノードに配信）
- **ポート**: 共通のポート番号で待ち受け
- **例**: リズムマシンがMIDIノートでドラムを鳴らし、シンセがそれを受け取って音を再生

#### 2.2.2 同期システム
リズムジェネレータを中心とした高精度な同期システムを実装：

1. **PPQ (Pulses Per Quarter Note)**
   - 4分音符を24分割する標準的なMIDI同期方式
   - 例：120 BPMの場合
     - 1拍（4分音符）= 0.5秒
     - 1パルス = 約0.021秒（0.5秒÷24）
     - 16分音符 = 6パルス

2. **タイミング制御**
   - 理想的なタイミングを基準に次のクロックを生成
   - フレーム処理の遅延による誤差を防止
   - BPM変更時は適切にタイミングをリセット

3. **同期メッセージ**
   - `clock`: PPQパルス（24 PPQN）
   - `start`: シーケンス開始
   - `stop`: シーケンス停止
   - テンポ変更通知

4. **同期状態管理**
   - 各ノードは同期状態（synced）を監視
   - PPQカウントを追跡
   - 実行状態（running）を管理

#### 2.2.3 OSC拡張
ネットワーク越しの制御のために実装予定：
- 例: `/pyxelpatch/rhythm/bpm 130` でテンポ変更
- 外部ソフトウェア（TouchDesigner, Processing）との連携

### 2.3 ディレクトリ構成
```
pyxelpatch/
  ├── src/
  │    ├── common/          # 共通ユーティリティ
  │    │    ├── base_node.py    # 基底クラス
  │    │    ├── midi_utils.py   # MIDI通信ユーティリティ
  │    │    └── README.md       # 共通機能の説明
  │    └── nodes/           # ノードモジュール群
  │         ├── _0000_rhythm_gen/ # リズムジェネレータ
  │         ├── _0001_rhythm/     # リズムノード
  │         ├── _0002_synth/      # シンセノード
  │         └── その他のノード     # 同様の構成
  ├── setup.py
  └── requirements.txt
```

## 3. 実行方法・操作方法

各ノードは独立したターミナルで実行します。動かし方はそれぞれのノードのREADMEを参照ください。
**重要**: リズムジェネレータは必ず最初に起動し、他のノードはリズムジェネレータが起動している状態で実行してください。

## 4. 今後の拡張
- **ノード増設**: エフェクタ、サンプラー、フィルターなど追加ノードを実装
- **GUI接続管理**: ノード間の接続をGUIで管理できるように
- **外部MIDI対応**: 実際のMIDIデバイスとの連携
- **設定ファイル**: ポート番号やMIDIチャンネルの設定をJSON等で管理
- **同期の高度化**: 
  - 外部MIDIクロックとの同期
  - ネットワーク越しの同期精度向上
  - タイムコードベースの同期

---

# まとめ
本設計書は、**Pyxelを用いたマルチウィンドウ型の音楽・映像アプリケーション** の実装例です。各ノードを独立したウィンドウとして動作させ、UDPソケットを介したMIDIメッセージで連携することで、柔軟な拡張性と独立性を確保しています。リズムジェネレータを中心とした同期システムにより、安定した音楽・映像制作環境を実現します。
