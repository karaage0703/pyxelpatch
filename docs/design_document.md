# PyxelPatch 設計書

## 1. 概要
**PyxelPatch** は、Python言語とレトロゲームフレームワーク [Pyxel](https://github.com/kitao/pyxel) を用いて構築する、**ノードベースの音楽＆ビジュアルソフトウェア** です。Cycling '74 の **Max** (Max/MSP) に着想を得ており、複数の **ノード**（アプリケーションのコンポーネント）を組み合わせることで音楽や映像生成を行います。各ノードは独立したウィンドウで動作し、ノード間の通信は **MIDI** メッセージをUDPソケットで送受信することで実現します。

大まかな構成は以下のとおりです。

- **リズムジェネレータ (RhythmGeneratorNode)**  
  システムのマスタークロックとして動作し、同期信号（テンポ, 拍, ステップなど）を出力。システム内で唯一のインスタンスとして存在し、他のノードはこれに同期する。
- **リズムマシン (RhythmNode)**  
  リズムジェネレータからの同期信号に基づいてドラムパターンを生成。
- **シンセ (SynthNode)**  
  MIDIノート入力から音声を生成するシンセサイザ。単純な波形合成を Pyxel のサウンド機能で行う。
- **映像ジェネレータ (VideoNode)**  
  MIDIメッセージやリズムにあわせて映像を生成・表示。Pyxelのグラフィック機能を使い、パーティクルなどの簡易ビジュアルを出力。
- **ゲーム (GameNode)**  
  Pyxelを使った簡単なゲーム機能。ユーザ操作やリズムに応じて音楽イベントを発火したり、逆にMIDIノートを受け取ったりする。

これらのノードはそれぞれ独立したウィンドウとして動作し、UDPソケットを介したMIDIメッセージのやり取りで連携します。各ノードは独立したディレクトリ（モジュール）として管理され、共通のインターフェース（基底クラス）を実装することで、**ソフトウェアデザインの一貫性** を保ちます。

## 2. アーキテクチャ

### 2.1 ノードベース構造
各ノードは独立したウィンドウとして動作し、それぞれが独自のPyxelアプリケーションとして実装されます。リズムジェネレータ、リズムマシン、シンセ、映像、ゲームなどをそれぞれ個別のフォルダ・スクリプトに分け実装します。

1. **RhythmGeneratorNode**  
   - システム唯一のマスタークロックとして動作  
   - テンポ（BPM）の管理と同期信号の生成  
   - MIDIクロックメッセージを他ノードに送信  
   - テンポを可変にし、UIやMIDIでBPMを変更可能  

2. **RhythmNode**  
   - リズムジェネレータからの同期信号に基づいてドラムパターンを生成  
   - パターンの編集・保存機能  
   - MIDIノート出力でドラム音を制御  

3. **SynthNode**  
   - MIDIノート入力を受けて音を再生する  
   - PyxelのサウンドAPIを用いて合成音を生成  
   - ボリュームや波形などをMIDI CCでコントロール可能  

4. **VideoNode**  
   - MIDIイベントに反応してビジュアル（パーティクルやフラッシュなど）を描画  
   - リズムからの同期信号により、拍やステップで映像を変化させる  
   - Pyxelの描画機能（`pyxel.rect()`, `pyxel.circ()`等）を利用  

5. **GameNode**  
   - Pyxel上で動作する簡易ゲーム。ユーザのキーボード入力やPyxelの操作を受け付ける  
   - イベント発生時にMIDIノートを生成し、シンセを鳴らしたり、映像を動かしたりできる  
   - ゲームロジック内でリズムやシンセからのイベントを受け、ゲーム難易度や動作を変化させるなども可能  

### 2.2 ノード間通信 (UDP MIDI)
- **MIDI over UDP**: 各ノードはUDPソケットを使用してMIDIメッセージを送受信します。
  - 例: リズムマシンがMIDIノートでドラムを鳴らす。シンセはMIDIノートを受け取り音を再生。
  - 各ノードは特定のポート番号でメッセージを待ち受け
  - JSON形式でMIDIメッセージをシリアライズして送受信
- **同期メッセージ**: リズムジェネレータは以下の同期信号を送信
  - MIDIクロック（24 PPQN）
  - 拍子位置（1小節の開始）
  - テンポ変更通知
- **OSC**: 拡張としてネットワーク越しに制御したい場合に用いる。  
  - 例: `/pyxelpatch/rhythm/bpm 130` などのアドレスを受け取ってテンポを変更  
  - MIDIと同様にノード間でのやり取り、あるいは外部ソフトウェア(例: TouchDesigner, Processing)との連携に活用  

### 2.3 クラス設計 (共通インターフェース)
以下のような **Node** 基底クラスを定義し、各ノードはこれを継承します。

```python
class Node:
    def __init__(self, name, in_channels=None):
        self.name = name
        self.enabled = True
        self.in_channels = in_channels if in_channels else []

    def on_midi(self, msg):
        """MIDIメッセージを受信した際の処理"""
        pass

    def update(self):
        """毎フレーム実行されるメインロジック"""
        pass

    def draw(self):
        """Pyxelの描画処理"""
        pass

class SyncNode(Node):
    """同期機能を持つノード用の基底クラス"""
    def __init__(self, name, in_channels=None):
        super().__init__(name, in_channels)
        self.synced = False
        self.last_clock = 0
        self.ppq_count = 0  # Pulses Per Quarter note カウンタ

    def on_clock(self, timestamp):
        """MIDIクロックを受信した際の処理"""
        self.last_clock = timestamp
        self.ppq_count = (self.ppq_count + 1) % 24
        if self.ppq_count == 0:
            self.on_quarter_note()

    def on_quarter_note(self):
        """4分音符のタイミングで呼ばれる"""
        pass
```

### 2.4 ディレクトリ構成
```
pyxelpatch/
  ├── src/
  │    ├── common/          # 共通ユーティリティ
  │    │    ├── base_node.py    # 基底クラス
  │    │    └── midi_utils.py   # MIDI通信ユーティリティ
  │    └── nodes/           # ノードモジュール群
  │         ├── _0000_rhythm_gen/ # リズムジェネレータ
  │         │    ├── __init__.py
  │         │    └── rhythm_generator_node.py
  │         ├── _0001_rhythm/ # リズムノード
  │         │    ├── __init__.py
  │         │    └── rhythm_node.py
  │         └── _0002_synth/  # シンセノード
  │              ├── __init__.py
  │              └── synth_node.py
  ├── setup.py
  └── requirements.txt
```

## 3. 実行方法・操作方法

各ノードは独立したターミナルで実行します。動かし方はそれぞれのノードのREADMEを参照ください。
**重要**: リズムジェネレータは必ず最初に起動し、他のノードはリズムジェネレータが起動している状態で実行してください。

## 4. 今後の拡張
- **ノード増設**: エフェクタ、サンプラー、フィルターなど追加ノードを実装
- **GUI接続管理**: ノード間の接続をGUIで管理できるように
- **外部MIDI対応**: 実際のMIDIデバイスとの連携
- **設定ファイル**: ポート番号やMIDIチャンネルの設定をJSON等で管理
- **同期の高度化**: 
  - 外部MIDIクロックとの同期
  - ネットワーク越しの同期精度向上
  - タイムコードベースの同期

---

# まとめ
本設計書は、**Pyxelを用いたマルチウィンドウ型の音楽・映像アプリケーション** の実装例です。各ノードを独立したウィンドウとして動作させ、UDPソケットを介したMIDIメッセージで連携することで、柔軟な拡張性と独立性を確保しています。リズムジェネレータを中心とした同期システムにより、安定した音楽・映像制作環境を実現します。
